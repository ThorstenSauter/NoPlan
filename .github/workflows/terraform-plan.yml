name: Terraform validate and plan

on:
  pull_request:
    branches:
      - main
    paths:
      - 'infra/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: ${{ vars.REGISTRY_NAME }}.azurecr.io/${{ vars.IMAGE_NAME }}:${{ github.sha }}

jobs:
  validate:
    name: Validate Terraform configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Terraform validate
        uses: ./.github/actions/terraform-validate
        with:
          working-directory: ./infra

  plan-staging:
    name: Plan staging environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Terraform plan
        uses: ./.github/actions/terraform-plan
        with:
          working-directory: ./infra/staging
          environment-name: Staging
          tf-api-token: ${{ secrets.TF_API_TOKEN }}
          image-name: ${{ env.IMAGE_NAME }}

  plan-production:
    name: Plan production environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Terraform plan
        uses: ./.github/actions/terraform-plan
        with:
          working-directory: ./infra/production
          environment-name: Production
          tf-api-token: ${{ secrets.TF_API_TOKEN }}
          image-name: ${{ env.IMAGE_NAME }}

  plan-global:
    name: Plan global environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Terraform plan
        uses: ./.github/actions/terraform-plan
        with:
          working-directory: ./infra/global
          environment-name: Global
          tf-api-token: ${{ secrets.TF_API_TOKEN }}
          image-name: ${{ env.IMAGE_NAME }}
